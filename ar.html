<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rtrevelin3dVR - AR Experience</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; font-family: Arial, sans-serif; overflow: hidden; }

        #ar-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        #video-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #canvas-ar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #ar-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 20, 40, 0.95);
            color: #00ffff;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #00ffff;
            font-size: 12px;
            z-index: 50;
            max-width: 280px;
        }

        #status-ar {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 20, 40, 0.95);
            color: #00ffff;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #00ffff;
            font-size: 11px;
            z-index: 50;
        }

        #btn-back {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #ff0055;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            z-index: 50;
            font-size: 14px;
        }

        #btn-back:hover { background: #ff0088; }

        .debug-log {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(0, 20, 40, 0.9);
            color: #00ff00;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #00ff00;
            font-size: 10px;
            max-width: 200px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 50;
        }
    </style>
</head>
<body>
    <div id="ar-container">
        <video id="video-bg" autoplay playsinline muted></video>
        <canvas id="canvas-ar"></canvas>

        <div id="ar-info">
            <p><strong>üîÆ Rtrevelin3dVR</strong></p>
            <p>Aponte para o marcador Hiro</p>
            <p id="marker-status" style="margin-top: 10px; color: #ffaa00;">Procurando marcador...</p>
            <p id="ar-debug" style="margin-top: 10px; color: #0088ff; font-size: 10px;"></p>
        </div>

        <div id="status-ar">
            <p>C√¢mera: <span id="camera-status">Ativa</span></p>
            <p>AR.js: <span id="arjs-status">Carregando...</span></p>
        </div>

        <button id="btn-back" onclick="voltarTeste()">‚Üê Voltar</button>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- AR.js -->
    <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/three.js/ar.js"></script>

    <script>
        const videoBg = document.getElementById('video-bg');
        const canvas = document.getElementById('canvas-ar');
        const markerStatusEl = document.getElementById('marker-status');
        const arDebugEl = document.getElementById('ar-debug');
        const arjsStatusEl = document.getElementById('arjs-status');

        let cameraStream = null;
        let arToolkitSource, arToolkitContext, scene, camera, renderer, markerRoot, cube;
        let markerDetected = false;

        function log(msg) {
            console.log(msg);
            arDebugEl.textContent = msg;
        }

        // Inicializar c√¢mera
        function initCamera() {
            log('Acessando c√¢mera...');

            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            })
            .then(stream => {
                cameraStream = stream;
                videoBg.srcObject = stream;
                log('C√¢mera OK');

                // Iniciar AR ap√≥s c√¢mera estar pronta
                setTimeout(() => {
                    initAR();
                }, 1500);
            })
            .catch(err => {
                log('Erro c√¢mera: ' + err.message);
                markerStatusEl.textContent = '‚úó Erro na c√¢mera';
                markerStatusEl.style.color = '#ff0055';
            });
        }

        // Inicializar AR.js
        function initAR() {
            log('Iniciando AR.js...');

            // Cena Three.js
            scene = new THREE.Scene();
            camera = new THREE.Camera();
            scene.add(camera);

            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                antialias: true, 
                alpha: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0);

            // AR Toolkit Source
            arToolkitSource = new THREEx.ArToolkitSource({
                sourceType: 'webcam'
            });

            arToolkitSource.init(() => {
                log('ArToolkitSource OK');
                setTimeout(() => {
                    onWindowResize();
                }, 1000);
            });

            window.addEventListener('resize', onWindowResize);

            function onWindowResize() {
                arToolkitSource.onResize();
                arToolkitSource.copySizeTo(renderer.domElement);
                if (arToolkitContext && arToolkitContext.arController !== null) {
                    arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
                }
            }

            // AR Toolkit Context
            arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: 'https://cdn.jsdelivr.net/npm/ar.js@3.4.5/data/data/camera_para.dat',
                detectionMode: 'mono',
                sourceWidth: 640,
                sourceHeight: 480
            });

            arToolkitContext.init(() => {
                log('ArToolkitContext OK');
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                arjsStatusEl.textContent = 'Pronto';
                arjsStatusEl.style.color = '#00ff00';
            });

            // Marcador Hiro
            markerRoot = new THREE.Group();
            scene.add(markerRoot);

            const markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                type: 'pattern',
                patternUrl: 'https://cdn.jsdelivr.net/npm/ar.js@3.4.5/data/data/patt.hiro'
            });

            log('Marcador Hiro carregado');

            // Cubo 3D
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshPhongMaterial({
                color: 0x00ffff,
                emissive: 0x0088ff,
                shininess: 100
            });
            cube = new THREE.Mesh(geometry, material);
            cube.position.z = 0.5;
            markerRoot.add(cube);

            // Esfera
            const sphereGeometry = new THREE.SphereGeometry(0.3, 32, 32);
            const sphereMaterial = new THREE.MeshPhongMaterial({
                color: 0x0088ff,
                emissive: 0x0044ff
            });
            const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            sphere.position.y = 1.5;
            markerRoot.add(sphere);

            // Texto 3D
            const canvas3d = document.createElement('canvas');
            canvas3d.width = 512;
            canvas3d.height = 256;
            const ctx = canvas3d.getContext('2d');
            ctx.fillStyle = '#00ffff';
            ctx.font = 'bold 60px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Rtrevelin3dVR', 256, 128);

            const texture = new THREE.CanvasTexture(canvas3d);
            const textMaterial = new THREE.MeshPhongMaterial({ map: texture });
            const textGeometry = new THREE.PlaneGeometry(2, 1);
            const textMesh = new THREE.Mesh(textGeometry, textMaterial);
            textMesh.position.z = 1.2;
            textMesh.position.y = 2;
            markerRoot.add(textMesh);

            // Luz
            const light = new THREE.PointLight(0xffffff, 1);
            light.position.set(5, 5, 5);
            scene.add(light);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            // Anima√ß√£o
            let frameCount = 0;
            function animate() {
                requestAnimationFrame(animate);
                frameCount++;

                if (cube) {
                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.01;
                }

                if (sphere) {
                    sphere.position.y = 1.5 + Math.sin(Date.now() * 0.001) * 0.3;
                }

                if (arToolkitSource.ready === false) return;

                arToolkitContext.update(arToolkitSource.domElement);

                // Debug a cada 60 frames
                if (frameCount % 60 === 0) {
                    if (markerRoot.visible) {
                        if (!markerDetected) {
                            markerDetected = true;
                            markerStatusEl.textContent = '‚úì Marcador detectado!';
                            markerStatusEl.style.color = '#00ff00';
                            log('Marcador encontrado!');
                        }
                    } else {
                        if (markerDetected) {
                            markerDetected = false;
                            markerStatusEl.textContent = 'Procurando marcador...';
                            markerStatusEl.style.color = '#ffaa00';
                            log('Procurando marcador...');
                        }
                    }
                }

                renderer.render(scene, camera);
            }

            animate();

            log('AR iniciado!');
        }

        // Voltar para teste
        function voltarTeste() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            window.location.href = 'index.html';
        }

        // Iniciar quando p√°gina carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                initCamera();
            }, 500);
        });
    </script>
</body>
</html>
